@startuml
!theme toy
title Payment Processing - Failed First Attempt during REST call with Retry on consumer side
autonumber
actor Client

Client -> ServiceA: POST /payment
activate ServiceA

ServiceA -> DB: Insert PENDING into payment_transaction
DB --> ServiceA: OK

ServiceA -> Kafka: Produce payment-request topic
Kafka --> ServiceA: OK

ServiceA -> ServiceC: POST /risk-score
activate ServiceC
ServiceC --> ServiceA: OK
deactivate ServiceC

ServiceA -> Kafka: Produce payment-validated topic
Kafka --> ServiceA: OK

ServiceA -> DB: Commit transaction
ServiceA -> Kafka: Commit transaction
deactivate ServiceA

Kafka -> ServiceB: Consume payment-request topic
activate ServiceB
ServiceB -> DB: Update status RECEIVED
DB --> ServiceB: OK

Kafka -> ServiceB: Consume payment-validated topic
ServiceB -> ServiceC: POST /confirm-risk
activate ServiceC
ServiceC --> ServiceB: timeout or error
deactivate ServiceC

ServiceB -> ServiceB: Retry REST call
ServiceB -> ServiceC: POST /confirm-risk
ServiceC --> ServiceB: OK

ServiceB -> DB: Update status COMPLETED
DB --> ServiceB: OK
deactivate ServiceB

@enduml
